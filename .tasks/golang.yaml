version: '3'

tasks:
  grpcgen:
    desc: Run 'buf generate'
    dir: "{{.git_root}}"
    cmds:
      - task: :isolation:go-action
        vars: { CMD: "buf generate" }
    silent: true

  tidy:
    desc: Run 'go mod tidy'
    dir: "{{.git_root}}"
    deps: [ grpcgen ]
    cmds:
      - task: :isolation:go-action
        vars: { CMD: "go mod tidy" }
    silent: true

  vendor:
    desc: Run 'go mod vendor'
    dir: "{{.git_root}}"
    deps: [ tidy ]
    cmds:
      - task: :isolation:go-action
        vars: { CMD: "go mod vendor" }
    silent: true

  test:
    desc: Run 'go test'
    dir: "{{.git_root}}"
    deps: [ vendor ]
    cmds:
      - task: :isolation:go-action
        vars: { CMD: "go test ./..." }
    silent: true

  lint:
    desc: Run 'golangci-lint run'
    dir: "{{.git_root}}"
    deps: [ vendor ]
    cmds:
      - task: :isolation:go-action
        vars: { CMD: "golangci-lint run" }
    silent: true

  fumpt:
    desc: Run 'gofumpt'
    dir: "{{.git_root}}"
    deps: [ vendor ]
    cmds:
      - task: :isolation:go-action
        vars: { CMD: "sh -c 'git ls-files \"*.go\" | xargs gofumpt -l -w'" }
    silent: true
