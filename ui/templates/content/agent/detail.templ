package agent

import (
	v1 "github.com/soltiHQ/control-plane/api/v1"
	"github.com/soltiHQ/control-plane/internal/ui/policy"
	"github.com/soltiHQ/control-plane/internal/ui/routepath"
	"github.com/soltiHQ/control-plane/internal/ui/trigger"
	"github.com/soltiHQ/control-plane/ui/templates/asset"
	"github.com/soltiHQ/control-plane/ui/templates/component/button"
	"github.com/soltiHQ/control-plane/ui/templates/component/card"
	"github.com/soltiHQ/control-plane/ui/templates/component/form"
	"github.com/soltiHQ/control-plane/ui/templates/component/modal"
	"github.com/soltiHQ/control-plane/ui/templates/component/visual"
)

// Detail renders the agent identity card with labels editor and action buttons.
templ Detail(a v1.Agent, p policy.AgentDetail) {
	@Identity(a, p)
}

// Identity renders the agent info card body (returned as an HTMX fragment).
templ Identity(a v1.Agent, p policy.AgentDetail) {
	@card.Card("") {
		@card.CardBody() {
			<div class="space-y-6">
				<div class="space-y-2">
					@visual.Badge("Online", visual.VariantSuccess)
				</div>

				<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-6">
					<div class="space-y-3 min-w-0">
						<dl class="space-y-3">
							@visual.KV("Agent ID", a.ID)
							@visual.KV("Name", a.Name)
							@visual.KV("Endpoint", a.Endpoint)
							@visual.KV("Platform", a.Platform)
							@visual.KV("OS", a.OS)
							@visual.KV("Arch", a.Arch)
							if a.UptimeSeconds > 0 {
								@visual.KV("Uptime", formatUptime(a.UptimeSeconds))
							}
						</dl>
					</div>

					<div class="space-y-3 min-w-0">
						<dl class="space-y-3">
							@visual.BadgeMap("Labels", a.Labels, visual.VariantSecondary)
							@visual.BadgeMap("Metadata", a.Metadata, visual.VariantPrimary)
						</dl>
					</div>
				</div>
			</div>
		}

		@card.CardFooter() {
			if p.CanEditLabels {
				@button.Button("", "button", false, button.VariantSecondary, false,
					templ.Attributes{"x-data": "", "x-on:click": modal.OpenEvent("edit-agent-labels")},
				) {
					@asset.Icon("edit")
				}
			}
		}
	}

	if p.CanEditLabels {
		@labelsEditor(a)
	}
}

templ labelsEditor(a v1.Agent) {
	@modal.Modal("edit-agent-labels") {
		<form
			x-data={ kvEditorData(a.Labels) }
			x-on:submit.prevent={ kvSubmitExpr(routepath.ApiAgentLabels(a.ID), trigger.AgentUpdate) }
		>
			<div class="p-6 space-y-4">
				<h3 class="text-base font-semibold text-fg">Edit labels</h3>

				<!-- existing rows -->
				<template x-for="(row, idx) in rows" :key="idx">
					<div class="flex items-center gap-2">
						<input
							type="text"
							x-model="row.key"
							placeholder="key"
							class={ form.BaseInputClass + "h-9 px-3 text-sm font-mono" }
						/>
						<input
							type="text"
							x-model="row.value"
							placeholder="value"
							class={ form.BaseInputClass + "h-9 px-3 text-sm" }
						/>
						<button
							type="button"
							class="shrink-0 h-9 w-9 inline-flex items-center justify-center rounded-[var(--r-xs)] text-muted-strong hover:text-danger hover:bg-danger/10 transition-colors"
							x-on:click="rows.splice(idx, 1)"
						>
							<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4">
								<line x1="18" y1="6" x2="6" y2="18"></line>
								<line x1="6" y1="6" x2="18" y2="18"></line>
							</svg>
						</button>
					</div>
				</template>

				<!-- add button -->
				<button
					type="button"
					class="inline-flex items-center gap-1.5 text-xs font-medium text-primary hover:text-primary/80 transition-colors"
					x-on:click="rows.push({key: '', value: ''})"
				>
					@asset.Icon("add")
					<span>Add label</span>
				</button>
			</div>

			@modal.Footer() {
				@modal.CancelButton("Cancel")
				@button.Button("", "submit", false, button.VariantPrimary, false,
					templ.Attributes{"x-bind:disabled": "submitting"},
				) {
					<span x-show="!submitting">Save</span>
					<span x-show="submitting" x-cloak>Saving...</span>
				}
			}
		</form>
	}
}
